# 虚拟邮箱支持 - 执行计划

## 任务背景

钉钉企业用户可能没有邮箱，导致 Discourse 用户注册失败。需要支持虚拟邮箱机制。

## 需求确认

- ✅ 允许无邮箱用户注册（仅 unionId）
- ✅ 使用虚拟邮箱满足 Discourse 必需字段
- ✅ 不接收邮件通知（依赖钉钉）
- ✅ 姓名直接使用钉钉数据
- ✅ 用户名生成规则可配置，默认 `dingtalk_{hash(unionId)[0..5]}`

## 方案选择

采用方案 1：渐进式虚拟邮箱策略

### 邮箱获取优先级

1. 真实邮箱（email 字段存在且非空）→ email_valid = true
2. 手机号虚拟邮箱 → {mobile}@dingtalk.mobile → email_valid = false
3. UnionId 虚拟邮箱（最终降级）→ dingtalk_{unionid}@virtual.local → email_valid = false

## 实施阶段

### Phase 1: 配置项扩展
- 文件: config/settings.yml
- 新增 3 个配置项：虚拟邮箱开关、域名、用户名模板

### Phase 2: 国际化文本更新
- 文件: config/locales/*.yml
- 更新提示文本支持虚拟邮箱场景

### Phase 3: 核心认证逻辑改造
- 文件: lib/dingtalk_authenticator.rb
- 新增邮箱生成方法
- 新增用户名生成方法
- 改造 after_authenticate 方法

### Phase 4: 测试用例更新
- 文件: spec/lib/dingtalk_authenticator_spec.rb
- 新增虚拟邮箱测试
- 新增用户名生成测试

### Phase 5: 文档更新
- 文件: README.md, DEPLOYMENT.md
- 添加虚拟邮箱配置说明

### Phase 6: 验证脚本更新
- 文件: verify_plugin.sh
- 添加配置项验证

## 风险评估

- hash 冲突 → Discourse 自动追加数字后缀
- 邮箱验证 → email_valid = false 跳过
- 现有用户 → 不影响，只作用于新用户

## 测试检查清单

- [ ] 真实邮箱用户正常注册
- [ ] 手机号虚拟邮箱用户能注册
- [ ] UnionId 虚拟邮箱用户能注册
- [ ] 用户名模板生成正确
- [ ] 禁用虚拟邮箱后无邮箱用户无法注册

---

执行时间：2025-12-18
执行人：Claude Code
